---
phase: 11-autonomous-ai
plan: 03
type: execute
wave: 3
depends_on: ["11-02"]
files_modified:
  - src/stores/SimulationStore.ts
  - src/components/DecisionLogPanel.tsx
  - src/components/CharacterPanel.tsx
autonomous: true

must_haves:
  truths:
    - "AI processTick is called each simulation tick when simulation is running"
    - "Decision log panel shows last 5 decisions with activity name, reason, and score"
    - "Free Will toggle is visible near activity queue and functional"
    - "Player can toggle Free Will ON/OFF at any time"
  artifacts:
    - path: "src/stores/SimulationStore.ts"
      provides: "Simulation tick calls utilityAIStore.processTick"
      contains: "utilityAIStore.processTick"
    - path: "src/components/DecisionLogPanel.tsx"
      provides: "Decision log UI component"
      exports: ["DecisionLogPanel"]
    - path: "src/components/CharacterPanel.tsx"
      provides: "Character panel with Free Will toggle and Decision Log"
      contains: "DecisionLogPanel"
  key_links:
    - from: "src/stores/SimulationStore.ts"
      to: "src/stores/UtilityAIStore.ts"
      via: "processTick call in tick method"
      pattern: "this\\.root\\.utilityAIStore\\.processTick"
    - from: "src/components/DecisionLogPanel.tsx"
      to: "src/stores/UtilityAIStore.ts"
      via: "observer reading decisionLog"
      pattern: "decisionLog"
---

<objective>
Wire autonomous AI to simulation tick and create UI for decision visibility and Free Will toggle.

Purpose: Connect the AI system to the game loop so it runs each tick, and provide player visibility into AI decisions plus control over Free Will mode.

Output: AI running in simulation, Decision Log panel showing last 5 decisions, Free Will toggle in CharacterPanel.
</objective>

<execution_context>
@/Users/godstemning/.claude/get-shit-done/workflows/execute-plan.md
@/Users/godstemning/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-autonomous-ai/11-CONTEXT.md
@.planning/phases/11-autonomous-ai/11-RESEARCH.md
@.planning/phases/11-autonomous-ai/11-01-SUMMARY.md
@.planning/phases/11-autonomous-ai/11-02-SUMMARY.md

# Key existing files
@src/stores/SimulationStore.ts
@src/components/CharacterPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire AI to simulation tick</name>
  <files>src/stores/SimulationStore.ts</files>
  <action>
Add utilityAIStore.processTick() call to the simulation tick method:

1. Find the `tick()` method in SimulationStore
2. After the existing tick processing (character.applyTickUpdate, activityStore.processTick), add:
   ```typescript
   // Process autonomous AI decisions
   this.root.utilityAIStore.processTick();
   ```

This should be AFTER activityStore.processTick() so that:
- If an activity just completed, AI can pick the next one
- If player queued something, it won't be overridden

The order should be:
1. Character needs/stats update
2. Activity processing
3. AI decision (only if idle and no queue)
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/stores/SimulationStore.ts`</verify>
  <done>SimulationStore.tick() calls utilityAIStore.processTick() after activity processing</done>
</task>

<task type="auto">
  <name>Task 2: Create DecisionLogPanel component</name>
  <files>src/components/DecisionLogPanel.tsx</files>
  <action>
Create a collapsible panel showing AI decision history. Follow existing component patterns (observer, DaisyUI classes).

```typescript
import { observer } from 'mobx-react-lite';
import { useStore } from '../stores/StoreProvider';

export const DecisionLogPanel = observer(function DecisionLogPanel() {
  const { utilityAIStore, characterStore } = useStore();
  const character = characterStore.character;
  const decisions = utilityAIStore.decisionLog;

  if (!character) return null;

  return (
    <div className="collapse collapse-arrow bg-base-200 rounded-box">
      <input type="checkbox" />
      <div className="collapse-title text-sm font-medium">
        AI Decision Log ({decisions.length} recent)
      </div>
      <div className="collapse-content">
        {decisions.length === 0 ? (
          <p className="text-sm text-base-content/60">No autonomous decisions yet</p>
        ) : (
          <ul className="space-y-2">
            {decisions.slice().reverse().map((decision, index) => (
              <li key={`${decision.timestamp}-${index}`} className="text-sm border-l-2 border-primary pl-2">
                <div className="font-medium">
                  {decision.activityName}
                  {decision.criticalMode && (
                    <span className="badge badge-error badge-xs ml-1">Critical</span>
                  )}
                </div>
                <div className="text-base-content/70">{decision.topReason}</div>
                <div className="text-xs text-base-content/50">
                  Score: {Math.round(decision.score)}
                  {decision.topAlternatives.length > 0 && (
                    <> | Alt: {decision.topAlternatives.map(a => `${a.activityName} (${Math.round(a.score)})`).join(', ')}</>
                  )}
                </div>
                {/* Expandable breakdown - all 5 utility factors */}
                <details className="text-xs mt-1">
                  <summary className="cursor-pointer text-base-content/50">Breakdown</summary>
                  <div className="pl-2 mt-1 text-base-content/60">
                    <div>Need Urgency: {Math.round(decision.breakdown.needUrgency)}</div>
                    <div>Personality Fit: {Math.round(decision.breakdown.personalityFit)}</div>
                    <div>Resource Avail: {Math.round(decision.breakdown.resourceAvailability)}</div>
                    <div>Willpower Match: {Math.round(decision.breakdown.willpowerMatch)}</div>
                    <div>Mood Delta: {Math.round(decision.breakdown.moodDelta)}</div>
                  </div>
                </details>
              </li>
            ))}
          </ul>
        )}
      </div>
    </div>
  );
});
```

Key features:
- Collapsible panel (DaisyUI collapse)
- Shows last 5 decisions in reverse chronological order (most recent first)
- Each decision shows: activity name, top reason, score
- Critical mode badge when in survival mode
- Expandable breakdown showing all 5 utility factors (needUrgency, personalityFit, resourceAvailability, willpowerMatch, moodDelta)
- Alternative activities with scores
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/components/DecisionLogPanel.tsx`</verify>
  <done>DecisionLogPanel displays decision history with breakdown details</done>
</task>

<task type="auto">
  <name>Task 3: Add Free Will toggle and Decision Log to CharacterPanel</name>
  <files>src/components/CharacterPanel.tsx</files>
  <action>
Add Free Will toggle and Decision Log panel to CharacterPanel:

1. Import DecisionLogPanel:
   ```typescript
   import { DecisionLogPanel } from './DecisionLogPanel';
   ```

2. Find a suitable location near the activity queue section (after ActivityQueue or NeedsPanel).

3. Add Free Will toggle using DaisyUI toggle component:
   ```typescript
   {/* Free Will Toggle */}
   <div className="form-control">
     <label className="label cursor-pointer justify-start gap-2">
       <input
         type="checkbox"
         className="toggle toggle-primary toggle-sm"
         checked={character.freeWillEnabled}
         onChange={(e) => character.setFreeWill(e.target.checked)}
       />
       <span className="label-text">Free Will</span>
       <span className="text-xs text-base-content/50">
         {character.freeWillEnabled ? '(AI fills idle time)' : '(Manual only)'}
       </span>
     </label>
   </div>
   ```

4. Add DecisionLogPanel below the toggle:
   ```typescript
   <DecisionLogPanel />
   ```

Place these in a logical location - ideally in a section that shows autonomous behavior controls. If there's an activity queue section, place nearby. Use appropriate spacing (mt-2 or similar).

The toggle should be clearly visible and easy to toggle during gameplay.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/components/CharacterPanel.tsx`</verify>
  <done>CharacterPanel includes Free Will toggle and DecisionLogPanel</done>
</task>

</tasks>

<verification>
1. All files compile without TypeScript errors
2. Run dev server and verify:
   - Simulation runs AI tick each cycle
   - Free Will toggle appears and is functional
   - Decision Log panel shows decisions when AI picks activities
</verification>

<success_criteria>
- AI processTick runs each simulation tick
- Free Will toggle visible near activity queue
- Decision Log shows last 5 decisions with activity, reason, score
- Clicking toggle changes character.freeWillEnabled
- AI only picks activities when Free Will ON, idle, and no queue
</success_criteria>

<output>
After completion, create `.planning/phases/11-autonomous-ai/11-03-SUMMARY.md`
</output>
