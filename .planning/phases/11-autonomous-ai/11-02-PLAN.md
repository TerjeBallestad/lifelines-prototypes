---
phase: 11-autonomous-ai
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/stores/UtilityAIStore.ts
  - src/stores/RootStore.ts
  - src/entities/Character.ts
autonomous: true

must_haves:
  truths:
    - "UtilityAIStore scores all available activities when patient is idle"
    - "AI picks from top 3-5 scoring activities with weighted random selection"
    - "Critical needs (below 15%) trigger pure urgency scoring without personality"
    - "Free Will toggle per character controls whether AI picks activities"
  artifacts:
    - path: "src/stores/UtilityAIStore.ts"
      provides: "Autonomous AI decision-making store"
      exports: ["UtilityAIStore"]
    - path: "src/stores/RootStore.ts"
      provides: "Root store with utilityAIStore reference"
      contains: "utilityAIStore"
    - path: "src/entities/Character.ts"
      provides: "Character with freeWillEnabled property"
      contains: "freeWillEnabled"
  key_links:
    - from: "src/stores/UtilityAIStore.ts"
      to: "src/utils/utilityScoring.ts"
      via: "import scoring functions"
      pattern: "import.*calculateUtilityScore.*from.*utilityScoring"
    - from: "src/stores/UtilityAIStore.ts"
      to: "src/utils/weightedRandom.ts"
      via: "import weighted selection"
      pattern: "import.*weightedSampleWithoutReplacement.*from.*weightedRandom"
    - from: "src/stores/RootStore.ts"
      to: "src/stores/UtilityAIStore.ts"
      via: "store instantiation"
      pattern: "new UtilityAIStore"
---

<objective>
Create the UtilityAIStore that implements autonomous activity selection.

Purpose: Build the core AI decision-making system that evaluates activities, applies utility scoring, and selects activities for idle patients when Free Will is enabled.

Output: UtilityAIStore integrated into RootStore, Character entity with freeWillEnabled property.
</objective>

<execution_context>
@/Users/godstemning/.claude/get-shit-done/workflows/execute-plan.md
@/Users/godstemning/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-autonomous-ai/11-CONTEXT.md
@.planning/phases/11-autonomous-ai/11-RESEARCH.md
@.planning/phases/11-autonomous-ai/11-01-SUMMARY.md

# Key existing files
@src/stores/ActivityStore.ts
@src/stores/RootStore.ts
@src/entities/Character.ts
@src/data/activities.ts
@src/utils/weightedRandom.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add freeWillEnabled to Character</name>
  <files>src/entities/Character.ts</files>
  <action>
Add Free Will toggle to Character entity:

1. Add property (near top, after currentSocialContext):
   ```typescript
   /** Free Will toggle - when true, AI fills idle time autonomously */
   freeWillEnabled = true; // Default ON per CONTEXT.md
   ```

2. Add action method:
   ```typescript
   /**
    * Action: Toggle Free Will mode for this character.
    * When enabled, AI will autonomously select activities when idle.
    * When disabled, character only does player-assigned activities.
    */
   setFreeWill(enabled: boolean): void {
     this.freeWillEnabled = enabled;
   }
   ```

Place the property in the class field declarations section.
Place the method near other action methods (after setName).

No other changes needed - makeAutoObservable will handle reactivity.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/entities/Character.ts`</verify>
  <done>Character has freeWillEnabled property defaulting to true, with setFreeWill action</done>
</task>

<task type="auto">
  <name>Task 2: Create UtilityAIStore</name>
  <files>src/stores/UtilityAIStore.ts</files>
  <action>
Create UtilityAIStore following existing store patterns (ActivityStore, SkillStore):

**Imports:**
```typescript
import { makeAutoObservable, observable } from 'mobx';
import type { RootStore } from './RootStore';
import type { Activity } from '../entities/Activity';
import type { Character } from '../entities/Character';
import type { AIDecision, UtilityWeights, UtilityFactors } from '../types/autonomy';
import { DEFAULT_UTILITY_WEIGHTS } from '../types/autonomy';
import {
  calculateUtilityScore,
  shouldOverrideToCriticalMode,
  scoreInCriticalMode,
  calculateNeedUrgency,
} from '../utils/utilityScoring';
import { weightedSampleWithoutReplacement } from '../utils/weightedRandom';
import { STARTER_ACTIVITIES } from '../data/activities';
```

**Required function signatures:**
```typescript
get character(): Character | null
getAvailableActivities(): Activity[]
makeDecision(): AIDecision | null
generateTopReason(activity: Activity, character: Character, factors: UtilityFactors, criticalMode: boolean): string
addDecision(decision: AIDecision): void
processTick(): void
```

**Class structure:**

1. Properties:
   - `decisionLog = observable.array<AIDecision>([])` - Last 5 decisions
   - `private readonly root: RootStore`
   - `private weights: UtilityWeights = DEFAULT_UTILITY_WEIGHTS`

2. Constructor:
   - Accept RootStore, store reference, call makeAutoObservable(this)

3. `get character(): Character | null` - Computed getter for current character

4. `getAvailableActivities(): Activity[]`
   - Create Activity instances from STARTER_ACTIVITIES
   - Filter by canStartActivity check from ActivityStore
   - Return only activities that can be started

5. `makeDecision(): AIDecision | null`
   - If no character, return null
   - Get available activities
   - If none available, return null
   - Check for critical mode: `shouldOverrideToCriticalMode(character)`
   - Get current activity from ActivityStore (for hysteresis)

   **If critical mode:**
   - Score activities using `scoreInCriticalMode`
   - Pick highest scoring activity (no variety in survival mode)
   - Build AIDecision with criticalMode: true
   - topReason: identify the critical need (e.g., "Hunger critical (12%)")

   **If normal mode:**
   - Score all activities with `calculateUtilityScore`
   - Sort by score descending
   - Take top 5 candidates
   - Filter: remove any scoring < 50% of best score
   - Calculate personality-based variety multiplier:
     ```typescript
     const varietyMultiplier = 1.0 +
       (character.personality.openness - 50) * 0.01 -
       (character.personality.conscientiousness - 50) * 0.005;
     ```
   - **Apply varietyMultiplier to weights for selection:**
     ```typescript
     // Higher varietyMultiplier flattens the weight distribution, increasing variety
     // The multiplier raises each score to its power, with values > 1 amplifying differences
     // and values < 1 flattening them (more random selection)
     const adjustedWeights = viable.map(([_, score]) =>
       Math.pow(score, 1 / varietyMultiplier)
     );
     const [selectedIndex] = weightedSampleWithoutReplacement(adjustedWeights, 1);
     const selected = viable[selectedIndex];
     ```
   - Build AIDecision with breakdown and topAlternatives (next 2 best)
   - topReason: derive from highest scoring factor

6. `generateTopReason(activity: Activity, character: Character, factors: UtilityFactors, criticalMode: boolean): string`
   - If criticalMode: find the critical need and return "Eating because Hunger critical (X%)"
   - Otherwise: pick the dominant factor from all 5:
     - needUrgency → "because hungry/tired/etc"
     - personalityFit → "because it fits personality"
     - resourceAvailability → "because resources available"
     - willpowerMatch → "because it's easy enough"
     - moodDelta → "because it would boost mood"
   - Return reason like "Eating because hungry" or "Tidying because it fits personality"

7. `addDecision(decision: AIDecision): void`
   - Push to decisionLog
   - If length > 5, shift oldest off

8. `processTick(): void`
   - Check character exists and freeWillEnabled is true
   - Check activityStore.isIdle is true (no current activity)
   - Check activityStore.queue.length === 0 (no player queue)
   - If all conditions met, call makeDecision()
   - If decision returned, enqueue activity and add to decision log

Export the class.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/stores/UtilityAIStore.ts`</verify>
  <done>UtilityAIStore implements makeDecision with critical mode override, weighted random selection from top 5, and decision logging</done>
</task>

<task type="auto">
  <name>Task 3: Integrate UtilityAIStore into RootStore</name>
  <files>src/stores/RootStore.ts</files>
  <action>
Add UtilityAIStore to RootStore following existing pattern:

1. Import at top:
   ```typescript
   import { UtilityAIStore } from './UtilityAIStore';
   ```

2. Add property declaration (after activityStore):
   ```typescript
   utilityAIStore: UtilityAIStore;
   ```

3. Initialize in constructor (after activityStore initialization):
   ```typescript
   this.utilityAIStore = new UtilityAIStore(this);
   ```

Follow the exact pattern used for other stores (characterStore, activityStore, etc.).
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/stores/RootStore.ts`</verify>
  <done>RootStore creates and exposes utilityAIStore instance</done>
</task>

</tasks>

<verification>
1. All three files compile without TypeScript errors
2. Character.freeWillEnabled defaults to true
3. UtilityAIStore.makeDecision returns AIDecision with proper structure
4. RootStore exposes utilityAIStore
</verification>

<success_criteria>
- UtilityAIStore scores activities using utility functions from Plan 01
- Critical mode (any physiological need < 15%) triggers pure urgency scoring
- Normal mode picks from top 5 candidates with weighted random selection
- Decision log stores last 5 decisions with full breakdown
- Free Will toggle on Character controls AI behavior
</success_criteria>

<output>
After completion, create `.planning/phases/11-autonomous-ai/11-02-SUMMARY.md`
</output>
