---
phase: 12-tuning-balance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/CalculationTracePanel.tsx
  - src/components/CharacterPanel.tsx
autonomous: true

must_haves:
  truths:
    - "Player can see calculation breakdown for Overskudd"
    - "Player can see calculation breakdown for Mood"
    - "Player can see calculation breakdown for Purpose"
    - "Player can expand trace to see nested dependencies"
  artifacts:
    - path: "src/components/CalculationTracePanel.tsx"
      provides: "Expandable calculation trace UI"
      min_lines: 100
  key_links:
    - from: "src/components/CalculationTracePanel.tsx"
      to: "Character.actionResources"
      via: "MobX observer reading character state"
      pattern: "character\\.actionResources"
    - from: "src/components/CharacterPanel.tsx"
      to: "CalculationTracePanel"
      via: "component import and render"
      pattern: "CalculationTracePanel"
---

<objective>
Create calculation trace panel showing why derived stats and action resources have their current values.

Purpose: Enables player to understand formula breakdowns (Overskudd = f(Mood, Energy, Purpose, Willpower)) for tuning and debugging.
Output: CalculationTracePanel component integrated into CharacterPanel.
</objective>

<execution_context>
@/Users/godstemning/.claude/get-shit-done/workflows/execute-plan.md
@/Users/godstemning/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-tuning-balance/12-CONTEXT.md
@.planning/phases/12-tuning-balance/12-RESEARCH.md

# Key existing patterns
@src/components/DecisionLogPanel.tsx (expandable details pattern)
@src/config/balance.ts (weight constants and config structure)
@src/entities/Character.ts (derived stat computation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CalculationTracePanel component</name>
  <files>src/components/CalculationTracePanel.tsx</files>
  <action>
Create CalculationTracePanel component following DecisionLogPanel expandable pattern:

1. Use DaisyUI collapse with collapse-arrow for main panel
2. Sections for:
   - Action Resources (Overskudd, socialBattery, Focus, Willpower)
   - Derived Wellbeing (Mood, Purpose, Nutrition)
3. Each stat shows:
   - Current value
   - Formula with weight constants from BalanceConfigStore
   - Input values substituted
   - Nested `<details>` to expand input dependencies (e.g., "Where does Mood come from?")
4. Include manual "Refresh" button (not real-time per CONTEXT.md)

Example structure for Overskudd:
```
Overskudd: 65.3
= (Mood × 0.4) + (Energy × 0.35) + (Purpose × 0.25)
= (72 × 0.4) + (58 × 0.35) + (65 × 0.25)
= 28.8 + 20.3 + 16.25
= 65.35 → 65.3

[> Where does Mood come from?]
  Mood: 72 (floor: 10, ceiling: 95)
  = sigmoid(weightedNeedAvg) + nutritionBonus
  = sigmoid(68) + 4
  ...
```

Use observer from mobx-react-lite. Read character from useCharacterStore.
Read weights from useRootStore().balanceConfig.
  </action>
  <verify>File exists and exports CalculationTracePanel component. TypeScript compiles without errors.</verify>
  <done>CalculationTracePanel component shows expandable calculation breakdowns for all derived stats and action resources.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate into CharacterPanel</name>
  <files>src/components/CharacterPanel.tsx</files>
  <action>
Add CalculationTracePanel to CharacterPanel:

1. Import CalculationTracePanel
2. Add new collapsible section after existing panels (e.g., after DecisionLogPanel or at bottom of dev tools area)
3. Only render when character exists
4. Position below the main character stats, possibly inside a "Debug Tools" section

The panel should be collapsed by default (user opts in to see traces).
  </action>
  <verify>`npm run build` succeeds. Panel visible in CharacterPanel when expanded.</verify>
  <done>CalculationTracePanel appears in CharacterPanel UI and can be expanded to see formula breakdowns.</done>
</task>

</tasks>

<verification>
- CalculationTracePanel shows Overskudd breakdown with Mood, Energy, Purpose contributions
- CalculationTracePanel shows Mood breakdown with need weights
- Nested expansion works (can drill into "Where does Mood come from?")
- Manual refresh button updates values
- No TypeScript errors
</verification>

<success_criteria>
- Player can inspect Overskudd calculation trace showing formula and input values
- Player can inspect Mood calculation trace showing need contributions
- Nested dependencies expandable (2 layers deep)
- Refresh button updates all traces
</success_criteria>

<output>
After completion, create `.planning/phases/12-tuning-balance/12-01-SUMMARY.md`
</output>
