---
phase: 08-derived-wellbeing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/entities/types.ts
  - src/config/balance.ts
  - src/utils/curves.ts
  - src/utils/smoothing.ts
autonomous: true

must_haves:
  truths:
    - "DerivedStats interface exists with mood, purpose, nutrition fields"
    - "FoodQuality enum exists with Bad/OK/Good/Great values"
    - "DerivedStatsConfig is part of BalanceConfig with tunable parameters"
    - "needToMoodCurve function produces curve-based contributions"
    - "SmoothedValue class enables exponential smoothing for lag"
  artifacts:
    - path: "src/entities/types.ts"
      provides: "DerivedStats interface, FoodQuality enum, StatBreakdown interface"
      contains: "interface DerivedStats"
    - path: "src/config/balance.ts"
      provides: "DerivedStatsConfig interface with smoothing alphas and weights"
      contains: "interface DerivedStatsConfig"
    - path: "src/utils/curves.ts"
      provides: "needToMoodCurve sigmoid function, asymptoticClamp utility"
      exports: ["needToMoodCurve", "asymptoticClamp"]
    - path: "src/utils/smoothing.ts"
      provides: "SmoothedValue class for exponential moving average"
      exports: ["SmoothedValue"]
  key_links:
    - from: "src/config/balance.ts"
      to: "DerivedStatsConfig"
      via: "derivedStats field in BalanceConfig"
      pattern: "derivedStats: DerivedStatsConfig"
---

<objective>
Create type definitions, configuration, and utility functions for the derived wellbeing system.

Purpose: Establish foundation types (DerivedStats, FoodQuality, StatBreakdown), balance config (DerivedStatsConfig), and mathematical utilities (sigmoid curves, exponential smoothing) that Plan 02 will use for Character integration.

Output: Types in types.ts, config in balance.ts, curve utilities in curves.ts, smoothing utilities in smoothing.ts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-derived-wellbeing/08-CONTEXT.md
@.planning/phases/08-derived-wellbeing/08-RESEARCH.md
@src/entities/types.ts
@src/config/balance.ts
@src/utils/needsDecay.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Derived Stats Types and FoodQuality Enum</name>
  <files>src/entities/types.ts</files>
  <action>
Add to src/entities/types.ts after the Needs section:

1. DerivedStats interface with three fields:
   - mood: number (0-100, computed from need satisfaction)
   - purpose: number (0-100, personality equilibrium system)
   - nutrition: number (0-100, slow-moving food quality stat)

2. FoodQuality enum for nutrition tracking:
   - Bad = 0 (junk food)
   - OK = 1 (basic meals)
   - Good = 2 (balanced nutrition)
   - Great = 3 (premium healthy food)

3. StatBreakdown interface for UI tooltips:
   - total: number (the displayed value)
   - contributions: Array<{ source: string; value: number }>

4. defaultDerivedStats() factory function returning:
   - mood: 50 (neutral starting point)
   - purpose: 50 (neutral, will adjust to personality equilibrium)
   - nutrition: 70 (decent starting diet)

Follow existing pattern from Needs section. Export all new types.
  </action>
  <verify>TypeScript compilation passes: `npx tsc --noEmit`</verify>
  <done>DerivedStats interface, FoodQuality enum, StatBreakdown interface, and defaultDerivedStats factory exported from types.ts</done>
</task>

<task type="auto">
  <name>Task 2: Add Derived Stats Configuration</name>
  <files>src/config/balance.ts</files>
  <action>
Add DerivedStatsConfig interface and defaults to src/config/balance.ts:

1. Create DerivedStatsConfig interface with:
   - moodSmoothingAlpha: number (0.1 = moderate lag)
   - moodFloor: number (10 = minimum mood, prevents 0)
   - moodCeiling: number (95 = maximum mood, prevents 100)
   - needWeights: Record with weights for each need (hunger: 1.5, energy: 1.5, hygiene: 1.0, bladder: 1.0, social: 1.0, fun: 1.0, security: 1.0)
   - purposeSmoothingAlpha: number (0.05 = slower than mood)
   - purposeDecayRate: number (0.02 = decay toward equilibrium)
   - purposeEquilibriumWeights: { conscientiousness: 20, openness: 10 }
   - nutritionSmoothingAlpha: number (0.01 = very slow)
   - nutritionEnergyModMin: number (0.5 = 50% at nutrition 0)
   - nutritionEnergyModMax: number (1.0 = 100% at nutrition 100)
   - nutritionMoodPenalty: number (-20 = max penalty at nutrition 0)

2. Create DEFAULT_DERIVED_STATS_CONFIG with values from above.

3. Add derivedStats: DerivedStatsConfig to BalanceConfig interface.

4. Add derivedStats: DEFAULT_DERIVED_STATS_CONFIG to DEFAULT_BALANCE.

5. Add derivedStatsConfig getter to BalanceConfigStore class.

Follow existing pattern from NeedsConfig.
  </action>
  <verify>TypeScript compilation passes: `npx tsc --noEmit`</verify>
  <done>DerivedStatsConfig added to balance.ts with tunable parameters for mood smoothing, purpose equilibrium, and nutrition effects</done>
</task>

<task type="auto">
  <name>Task 3: Create Curve and Smoothing Utilities</name>
  <files>src/utils/curves.ts, src/utils/smoothing.ts</files>
  <action>
Create two new utility files:

**src/utils/curves.ts:**

1. needToMoodCurve(value: number, weight: number = 1.0, steepness: number = 2.0): number
   - Sigmoid curve for need-to-mood contribution
   - Formula: x^λ / (x^λ + σ^λ) where σ=0.5, λ=steepness
   - Normalize value (0-100) to x (0-1)
   - Map curve output (0-1) to contribution: (curve - 0.5) * 100 * weight
   - Returns contribution that can be negative (low need) or positive (high need)

2. asymptoticClamp(value: number, min: number, max: number, strength: number = 0.9): number
   - Soft bounds that prevent reaching exact min/max
   - If value < min: return min - (min - value) * strength
   - If value > max: return max + (value - max) * strength
   - Otherwise return value unchanged

**src/utils/smoothing.ts:**

1. SmoothedValue class:
   - Private current: number
   - Private alpha: number
   - constructor(initialValue: number, alpha: number = 0.1)
   - update(target: number): number - apply exponential smoothing: current = current + alpha * (target - current), return current
   - getValue(): number
   - setValue(value: number): void
   - setAlpha(alpha: number): void

Add JSDoc comments explaining the math (reference GMTK Sims article for curves, standard EMA for smoothing).
  </action>
  <verify>TypeScript compilation passes: `npx tsc --noEmit`</verify>
  <done>curves.ts exports needToMoodCurve and asymptoticClamp; smoothing.ts exports SmoothedValue class</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - All TypeScript compiles without errors
2. types.ts exports DerivedStats, FoodQuality, StatBreakdown, defaultDerivedStats
3. balance.ts exports DerivedStatsConfig, DEFAULT_DERIVED_STATS_CONFIG
4. BalanceConfigStore has derivedStatsConfig getter
5. curves.ts exports needToMoodCurve, asymptoticClamp
6. smoothing.ts exports SmoothedValue class
</verification>

<success_criteria>
- Foundation types defined for derived wellbeing system
- Balance config extended with tunable derived stats parameters
- Curve and smoothing utilities ready for Character integration
- All TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/08-derived-wellbeing/08-01-SUMMARY.md`
</output>
