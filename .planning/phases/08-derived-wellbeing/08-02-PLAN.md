---
phase: 08-derived-wellbeing
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/entities/Character.ts
autonomous: true

must_haves:
  truths:
    - "Character.computedMoodTarget returns curve-based mood from need satisfaction"
    - "Character.moodBreakdown returns contributions for tooltip display"
    - "Character.purposeEquilibrium returns personality-based baseline (Conscientiousness + Openness)"
    - "Character.applyDerivedStatsUpdate smoothly updates mood toward target and purpose toward equilibrium"
    - "Nutrition modifiers affect Energy regen (getNutritionEnergyModifier) and Mood baseline (getNutritionMoodModifier)"
  artifacts:
    - path: "src/entities/Character.ts"
      provides: "Derived stats logic integrated into Character class"
      contains: "computedMoodTarget"
  key_links:
    - from: "src/entities/Character.ts"
      to: "src/utils/curves.ts"
      via: "import needToMoodCurve"
      pattern: "import.*needToMoodCurve.*from"
    - from: "src/entities/Character.ts"
      to: "src/utils/smoothing.ts"
      via: "import SmoothedValue"
      pattern: "import.*SmoothedValue.*from"
    - from: "Character.applyTickUpdate"
      to: "Character.applyDerivedStatsUpdate"
      via: "method call when needs enabled"
      pattern: "applyDerivedStatsUpdate"
---

<objective>
Integrate derived wellbeing stats into Character class with smoothed mood computation, personality-based purpose equilibrium, and nutrition modifiers.

Purpose: Character class becomes the central hub for derived stats, computing mood from needs via sigmoid curves, maintaining purpose around personality-based equilibrium, and tracking nutrition effects on Energy and Mood.

Output: Character.ts extended with derived stats properties, computed getters, and tick update logic.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-derived-wellbeing/08-CONTEXT.md
@.planning/phases/08-derived-wellbeing/08-RESEARCH.md
@.planning/phases/08-derived-wellbeing/08-01-SUMMARY.md
@src/entities/Character.ts
@src/entities/types.ts
@src/config/balance.ts
@src/utils/curves.ts
@src/utils/smoothing.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Derived Stats Properties and Initialization</name>
  <files>src/entities/Character.ts</files>
  <action>
Add to Character class:

1. Import new types and utilities:
   - Import DerivedStats, FoodQuality, StatBreakdown, defaultDerivedStats, NeedKey from types.ts
   - Import needToMoodCurve, asymptoticClamp from curves.ts
   - Import SmoothedValue from smoothing.ts

2. Add properties (after existing needs property):
   - derivedStats?: DerivedStats (optional, v1.1 derived wellbeing stats)
   - private moodSmoother?: SmoothedValue (transient, not serialized)
   - private purposeSmoother?: SmoothedValue (transient)
   - private nutritionSmoother?: SmoothedValue (transient)
   - private recentFoodQuality: number = 1.0 (running average of food quality, 0-3 scale)

3. Create initializeDerivedStats() method:
   - Guard: only if root?.balanceConfig exists
   - Set this.derivedStats = defaultDerivedStats()
   - Get config from this.root.balanceConfig.derivedStatsConfig
   - Initialize moodSmoother with derivedStats.mood and config.moodSmoothingAlpha
   - Initialize purposeSmoother with derivedStats.purpose and config.purposeSmoothingAlpha
   - Initialize nutritionSmoother with derivedStats.nutrition and config.nutritionSmoothingAlpha

4. Update initializeNeeds() to also call initializeDerivedStats() at the end.

Follow existing code patterns and add JSDoc comments.
  </action>
  <verify>TypeScript compilation passes: `npx tsc --noEmit`</verify>
  <done>Character has derivedStats property and smoothers initialized when needs system enabled</done>
</task>

<task type="auto">
  <name>Task 2: Add Mood and Purpose Computed Getters</name>
  <files>src/entities/Character.ts</files>
  <action>
Add computed getters to Character class:

1. get computedMoodTarget(): number
   - Guard: if no needs or no balanceConfig, return 50
   - Get config = this.root.balanceConfig.derivedStatsConfig
   - Get weights from config.needWeights
   - For each need (hunger, energy, hygiene, bladder, social, fun, security):
     - Get weight from config (physiological = 1.5, social = 1.0)
     - Compute contribution using needToMoodCurve(needValue, weight, 2.5)
     - Accumulate totalContribution and totalWeight
   - Compute avgContribution = totalContribution / totalWeight
   - Compute mood = 50 + avgContribution
   - Apply nutrition modifier: mood += getNutritionMoodModifier()
   - Return asymptoticClamp(mood, config.moodFloor, config.moodCeiling)

2. get moodBreakdown(): StatBreakdown
   - Guard: if no needs, return { total: 50, contributions: [] }
   - Build contributions array with each need's contribution (source: capitalize(needKey), value: rounded contribution)
   - Add nutrition modifier if significant (|value| > 0.5)
   - Return { total: Math.round(derivedStats?.mood ?? 50), contributions }

3. get purposeEquilibrium(): number
   - Guard: if no balanceConfig, return 50
   - Get config = this.root.balanceConfig.derivedStatsConfig
   - Get { conscientiousness, openness } from this.personality
   - Start equilibrium = 50
   - Add conscientiousness modifier: ((conscientiousness - 50) / 50) * config.purposeEquilibriumWeights.conscientiousness
   - Add openness modifier: ((openness - 50) / 50) * config.purposeEquilibriumWeights.openness
   - Return Math.max(20, Math.min(80, equilibrium)) (clamped to reasonable range)

Add helper: capitalizeFirst(str: string): string at top of file (or reuse if exists).
  </action>
  <verify>TypeScript compilation passes: `npx tsc --noEmit`</verify>
  <done>Character has computedMoodTarget, moodBreakdown, and purposeEquilibrium computed getters</done>
</task>

<task type="auto">
  <name>Task 3: Add Nutrition Modifiers and Tick Update</name>
  <files>src/entities/Character.ts</files>
  <action>
Add nutrition methods and tick update to Character class:

1. private getNutritionMoodModifier(): number
   - Guard: if no derivedStats or no balanceConfig, return 0
   - Get config = this.root.balanceConfig.derivedStatsConfig
   - Calculate: config.nutritionMoodPenalty * (1 - this.derivedStats.nutrition / 100)
   - At nutrition 100: returns 0 (no penalty)
   - At nutrition 0: returns full penalty (-20)

2. getNutritionEnergyModifier(): number (public, used by Phase 9)
   - Guard: if no derivedStats or no balanceConfig, return 1.0
   - Get config = this.root.balanceConfig.derivedStatsConfig
   - Calculate: config.nutritionEnergyModMin + (config.nutritionEnergyModMax - config.nutritionEnergyModMin) * (this.derivedStats.nutrition / 100)
   - At nutrition 0: returns 0.5 (50% energy regen)
   - At nutrition 100: returns 1.0 (100% energy regen)

3. eatFood(quality: FoodQuality): void
   - Update running average: this.recentFoodQuality = this.recentFoodQuality * 0.9 + quality * 0.1

4. boostPurpose(amount: number): void (called by meaningful activities in Phase 10)
   - Guard: if no derivedStats, return
   - Set new target: const newTarget = Math.min(95, this.derivedStats.purpose + amount)
   - Update smoother: this.purposeSmoother?.setValue(newTarget)

5. applyDerivedStatsUpdate(speedMultiplier: number): void
   - Guard: if no derivedStats or no balanceConfig, return
   - Get config = this.root.balanceConfig.derivedStatsConfig
   - Update Mood: this.derivedStats.mood = this.moodSmoother.update(this.computedMoodTarget)
   - Update Purpose (decay toward equilibrium):
     - Get target = this.purposeEquilibrium
     - Get decayRate = config.purposeDecayRate * speedMultiplier
     - Get currentTarget = this.purposeSmoother.getValue()
     - Compute newTarget = currentTarget - (currentTarget - target) * decayRate
     - this.purposeSmoother.setValue(newTarget)
     - this.derivedStats.purpose = this.purposeSmoother.getValue()
   - Update Nutrition:
     - Compute targetNutrition = (this.recentFoodQuality / 3) * 100
     - this.derivedStats.nutrition = this.nutritionSmoother.update(targetNutrition)

6. Update applyTickUpdate() to call applyDerivedStatsUpdate(speedMultiplier) after applyNeedsDecay() when needsEnabled.

Add null checks on smoothers before calling update (they may not be initialized).
  </action>
  <verify>TypeScript compilation passes: `npx tsc --noEmit`</verify>
  <done>Character has nutrition modifiers, eatFood/boostPurpose actions, and applyDerivedStatsUpdate integrating derived stats into tick loop</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - All TypeScript compiles without errors
2. Character class has derivedStats property
3. initializeNeeds() also initializes derivedStats
4. computedMoodTarget returns curve-based value (not simple average)
5. moodBreakdown returns array of contributions for tooltip
6. purposeEquilibrium varies by personality (high C/O = higher equilibrium)
7. getNutritionEnergyModifier and getNutritionMoodModifier return correct ranges
8. applyTickUpdate calls applyDerivedStatsUpdate when needs enabled
</verification>

<success_criteria>
- Mood computed from needs using sigmoid curves with floor/ceiling
- Purpose decays toward personality-based equilibrium
- Nutrition affects Energy regen modifier and Mood baseline
- All derived stats update smoothly each tick via exponential smoothing
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/08-derived-wellbeing/08-02-SUMMARY.md`
</output>
