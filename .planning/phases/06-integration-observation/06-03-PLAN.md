---
phase: 06-integration-observation
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - src/components/ComparisonView.tsx
  - src/stores/CharacterStore.ts
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Two characters can run side-by-side simultaneously"
    - "Each character has its own CharacterPanel, activity queue, and state"
    - "Different archetypes produce visibly different behavior over time"
    - "User can toggle between single and comparison mode"
  artifacts:
    - path: "src/components/ComparisonView.tsx"
      provides: "Side-by-side character comparison"
      exports: ["ComparisonView"]
  key_links:
    - from: "src/components/ComparisonView.tsx"
      to: "src/stores/CharacterStore.ts"
      via: "multi-character support"
      pattern: "characters\\[|getCharacter"
    - from: "src/App.tsx"
      to: "src/components/ComparisonView.tsx"
      via: "comparison mode toggle"
      pattern: "ComparisonView|comparisonMode"
---

<objective>
Implement side-by-side comparison mode for emergence validation.

Purpose: Allow observing two contrasting characters (e.g., Hermit vs Social Butterfly) running simultaneously to validate that different personalities produce different behaviors.

Output:
- Multi-character support in CharacterStore
- ComparisonView component with side-by-side layout
- Toggle between single and comparison mode in App
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-integration-observation/06-CONTEXT.md
@.planning/phases/06-integration-observation/06-RESEARCH.md
@.planning/phases/06-integration-observation/06-02-SUMMARY.md

@src/stores/CharacterStore.ts
@src/stores/SimulationStore.ts
@src/components/CharacterPanel.tsx
@src/App.tsx
@src/data/archetypes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Multi-character CharacterStore</name>
  <files>src/stores/CharacterStore.ts</files>
  <action>
Update `src/stores/CharacterStore.ts` to support multiple characters:

1. Change data structure:
   ```typescript
   // Replace single character with map
   characters: Map<string, Character> = new Map();
   activeCharacterId: string | null = null;
   ```

2. Update/add methods:

   `createCharacter(name: string): Character` - keep existing logic, add to map:
   ```typescript
   createCharacter(name: string): Character {
     const char = new Character({
       id: crypto.randomUUID(),
       name,
       personality: defaultPersonality(),
       capacities: defaultCapacities(),
       resources: defaultResources(),
     });
     char.setRootStore(this.root);
     this.characters.set(char.id, char);
     if (!this.activeCharacterId) {
       this.activeCharacterId = char.id;
     }
     return char;
   }
   ```

   `createFromData(data: CharacterData): Character` - add to map:
   ```typescript
   createFromData(data: CharacterData): Character {
     const char = new Character(data);
     char.setRootStore(this.root);
     this.characters.set(char.id, char);
     if (!this.activeCharacterId) {
       this.activeCharacterId = char.id;
     }
     return char;
   }
   ```

   `getCharacter(id: string): Character | undefined`

   `removeCharacter(id: string): void` - removes from map, clears activeCharacterId if it was active

   `clearCharacter(): void` - for backward compat, remove active character

   `setActiveCharacter(id: string): void`

3. Update computed properties:
   - `get character()` - returns `this.characters.get(this.activeCharacterId ?? '')`
   - `get hasCharacter()` - returns `this.characters.size > 0`
   - `get allCharacters(): Character[]` - returns `Array.from(this.characters.values())`

4. Note: SimulationStore.tick() calls characterStore.character?.applyTickUpdate() - this still works for single mode. For comparison mode, we'll iterate allCharacters in ComparisonView's setup.
  </action>
  <verify>
`npx tsc --noEmit` passes
Existing single-character functionality still works
  </verify>
  <done>
CharacterStore supports multiple characters with map-based storage
  </done>
</task>

<task type="auto">
  <name>Task 2: ComparisonView and App integration</name>
  <files>src/components/ComparisonView.tsx, src/App.tsx, src/stores/SimulationStore.ts</files>
  <action>
1. Update `src/stores/SimulationStore.ts` to tick all characters:
   ```typescript
   // In tick() method, change:
   // this.rootStore.characterStore.character?.applyTickUpdate(this.speed);
   // To:
   for (const char of this.rootStore.characterStore.allCharacters) {
     char.applyTickUpdate(this.speed);
   }
   ```

2. Create `src/components/ComparisonView.tsx`:
   - Implement side-by-side grid layout per RESEARCH.md
   - Allow selecting archetype for each side

   ```tsx
   import { observer } from 'mobx-react-lite';
   import { useState } from 'react';
   import { useCharacterStore, useRootStore } from '../stores/RootStore';
   import { ARCHETYPES, createArchetypeCharacter } from '../data/archetypes';
   import { CharacterPanel } from './CharacterPanel';
   import { SkillTreePanel } from './SkillTreePanel';
   import { ActivityPanel } from './ActivityPanel';
   import { TalentsPanel } from './TalentsPanel';

   // Props version of panels that accept characterId
   // For simplicity, we'll modify existing panels to optionally accept characterId
   // OR we create a CharacterContext for scoped access

   export const ComparisonView = observer(function ComparisonView() {
     const characterStore = useCharacterStore();
     const [char1Id, setChar1Id] = useState<string | null>(null);
     const [char2Id, setChar2Id] = useState<string | null>(null);

     // Setup: Create two characters if not yet
     const setupComparison = (arch1Index: number, arch2Index: number) => {
       // Clear existing
       for (const id of Array.from(characterStore.characters.keys())) {
         characterStore.removeCharacter(id);
       }

       const data1 = createArchetypeCharacter(ARCHETYPES[arch1Index].id);
       const data2 = createArchetypeCharacter(ARCHETYPES[arch2Index].id);

       const c1 = characterStore.createFromData(data1);
       const c2 = characterStore.createFromData(data2);

       setChar1Id(c1.id);
       setChar2Id(c2.id);
     };

     // If no comparison setup, show selection UI
     if (!char1Id || !char2Id) {
       return (
         <div className="p-8">
           <h2 className="text-2xl font-bold mb-4">Emergence Comparison</h2>
           <p className="mb-4 text-base-content/70">
             Select two contrasting archetypes to compare their behavior side-by-side.
           </p>

           <div className="flex flex-col gap-4">
             <h3 className="font-semibold">Suggested Comparisons:</h3>
             <div className="flex flex-wrap gap-2">
               <button
                 onClick={() => setupComparison(0, 1)}
                 className="btn btn-outline"
               >
                 Hermit vs Social Butterfly
               </button>
               <button
                 onClick={() => setupComparison(2, 3)}
                 className="btn btn-outline"
               >
                 Perfectionist vs Free Spirit
               </button>
               <button
                 onClick={() => setupComparison(4, 5)}
                 className="btn btn-outline"
               >
                 Competitor vs Peacemaker
               </button>
             </div>
           </div>
         </div>
       );
     }

     const char1 = characterStore.getCharacter(char1Id);
     const char2 = characterStore.getCharacter(char2Id);

     if (!char1 || !char2) {
       return <div className="p-8">Loading...</div>;
     }

     return (
       <div className="grid grid-cols-2 gap-4 min-h-screen">
         {/* Character 1 */}
         <div className="border-r border-base-300 overflow-y-auto">
           <div className="flex">
             <CharacterPanelScoped character={char1} />
             <div className="flex-1 p-2">
               <h3 className="text-lg font-bold mb-2">{char1.displayName}</h3>
               <p className="text-xs text-base-content/50 mb-4">
                 {ARCHETYPES.find(a => a.name === char1.name)?.expectedBehavior}
               </p>
               {/* Simplified view - just resources and personality for comparison */}
             </div>
           </div>
         </div>

         {/* Character 2 */}
         <div className="overflow-y-auto">
           <div className="flex">
             <CharacterPanelScoped character={char2} />
             <div className="flex-1 p-2">
               <h3 className="text-lg font-bold mb-2">{char2.displayName}</h3>
               <p className="text-xs text-base-content/50 mb-4">
                 {ARCHETYPES.find(a => a.name === char2.name)?.expectedBehavior}
               </p>
             </div>
           </div>
         </div>
       </div>
     );
   });

   // Scoped CharacterPanel that takes character directly (not from store)
   const CharacterPanelScoped = observer(function CharacterPanelScoped({
     character
   }: {
     character: Character
   }) {
     // Render personality radar, resources, capacities for this specific character
     // This is a simplified version focused on observation
     return (
       <div className="bg-base-200 w-64 p-4 flex flex-col gap-4">
         <h4 className="font-semibold">{character.displayName}</h4>
         <PersonalityRadar personality={character.personality} />
         <ResourcePanel resources={character.resources} />
         <CapacitiesRadar capacities={character.effectiveCapacities} />
       </div>
     );
   });
   ```

3. Update `src/App.tsx`:
   - Add state for comparison mode: `const [comparisonMode, setComparisonMode] = useState(false);`
   - Add toggle button in header area
   - Conditionally render ComparisonView or normal layout

   ```tsx
   {comparisonMode ? (
     <ComparisonView />
   ) : (
     <>
       <CharacterPanel />
       <main className="flex-1 p-4 overflow-y-auto">
         {/* existing content */}
       </main>
     </>
   )}
   ```

   Add toggle near title:
   ```tsx
   <div className="flex items-center gap-4 mb-6">
     <h1 className="text-2xl font-bold">Lifelines Prototype</h1>
     <button
       onClick={() => setComparisonMode(!comparisonMode)}
       className={clsx('btn btn-sm', comparisonMode && 'btn-primary')}
     >
       {comparisonMode ? 'Single Mode' : 'Compare Mode'}
     </button>
   </div>
   ```
  </action>
  <verify>
1. `npm run dev`
2. Click "Compare Mode" button
3. See archetype comparison selection
4. Click "Hermit vs Social Butterfly"
5. See two characters side-by-side
6. Start simulation - both characters' resources change over time
7. Observe different drain patterns (Hermit's social battery drains faster, stress builds)
  </verify>
  <done>
ComparisonView shows two characters side-by-side, simulation ticks both, different archetypes show different behavior patterns
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run dev` works
3. Single mode still works as before
4. Compare mode shows two characters
5. Simulation affects both characters
6. Different archetypes produce visible behavioral differences
</verification>

<success_criteria>
- Toggle between single and comparison mode
- Two characters run simultaneously in comparison mode
- Each character has visible personality/resources
- Hermit and Social Butterfly show noticeably different resource drain patterns
</success_criteria>

<output>
After completion, create `.planning/phases/06-integration-observation/06-03-SUMMARY.md`
</output>
