---
phase: 09.1-activity-difficulty
plan: 01
subsystem: game-mechanics
tags: [activity-system, difficulty, skills, mastery, game-balance]

# Dependency graph
requires:
  - phase: 08-mood-resource
    provides: Character entity with skill system
  - phase: 07-skill-mastery
    provides: Activity entity with mastery levels
provides:
  - Difficulty calculation system with skill and mastery modifiers
  - SkillRequirement and DifficultyBreakdown types
  - DifficultyConfig in BalanceConfig
  - Activity.getEffectiveDifficulty and getDifficultyBreakdown methods
affects: [09.1-02-difficulty-ui, 10-autonomous-decisions, activity-execution]

# Tech tracking
tech-stack:
  added: []
  patterns: [square-root-diminishing-returns, personalized-difficulty]

key-files:
  created:
    - src/types/difficulty.ts
  modified:
    - src/config/balance.ts
    - src/entities/types.ts
    - src/entities/Activity.ts

key-decisions:
  - "Square root diminishing returns for both skills and mastery (prevents min/maxing)"
  - "Max 1.5 stars reduction from skills, 1.0 from mastery (activities stay challenging)"
  - "Backward compatible: activities default to 3 stars difficulty if not specified"

patterns-established:
  - "Difficulty breakdown pattern: return object with base, effective, reductions, and per-source details for tooltips"
  - "Graceful degradation: missing skills default to level 0 (no reduction)"

# Metrics
duration: 3min
completed: 2026-01-23
---

# Phase 9.1 Plan 01: Difficulty Calculation Foundation Summary

**Activity difficulty personalized by character skills and mastery using square root diminishing returns, with breakdown data for UI tooltips**

## Performance

- **Duration:** 3 min
- **Started:** 2026-01-23T18:00:04Z
- **Completed:** 2026-01-23T18:02:46Z
- **Tasks:** 2
- **Files modified:** 4 (3 modified, 1 created)

## Accomplishments
- Type-safe difficulty system with SkillRequirement, DifficultyBreakdown, and DifficultyConfig interfaces
- Activity entity can calculate personalized difficulty based on character's skill levels and activity mastery
- Square root diminishing returns formula prevents min/maxing while still rewarding skill investment
- Full breakdown data structure for UI tooltips showing per-skill contributions

## Task Commits

Each task was committed atomically:

1. **Task 1: Create Difficulty Types and Config** - `36579d6` (feat)
2. **Task 2: Implement Difficulty Calculation on Activity** - `8c3b8c7` (feat)

## Files Created/Modified
- `src/types/difficulty.ts` - SkillRequirement, DifficultyBreakdown, DifficultyConfig interfaces for type safety
- `src/config/balance.ts` - Added DifficultyConfig with defaults (max reductions, diminishing returns curve)
- `src/entities/types.ts` - Added optional baseDifficulty and skillRequirements to ActivityData interface
- `src/entities/Activity.ts` - Added difficulty calculation methods: getEffectiveDifficulty, getDifficultyBreakdown

## Decisions Made

**Square root diminishing returns curve:**
- Chose sqrt over linear for both skills and mastery
- At skill level 5: 100% of maxReduction, level 10: 141% (but capped)
- Prevents overwhelming advantage at high levels while still rewarding progression

**Max reduction caps:**
- Skills: 1.5 stars max (prevents activities becoming trivial)
- Mastery: 1.0 star max (rewards practice but doesn't eliminate challenge)
- Combined max: 2.5 stars (5-star activity can go down to 2.5 minimum)

**Backward compatibility:**
- Activities without baseDifficulty default to 3 stars (medium difficulty)
- Activities without skillRequirements have no skill-based reduction
- Existing activities work unchanged

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - implementation proceeded smoothly with no TypeScript errors.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**Ready for Plan 02 (Difficulty UI):**
- getEffectiveDifficulty returns 1-5 star value for display
- getDifficultyBreakdown provides full data for tooltip hover
- Skill details include skillId, skillName, level, and reduction amount

**Ready for Plan 03 (Success Probability):**
- Effective difficulty available for success calculation
- Breakdown shows why difficulty is what it is (debugging/balancing)

**No blockers:**
- All types properly exported and importable
- Methods handle missing skills gracefully (no crashes)
- TypeScript compiles without errors

---
*Phase: 09.1-activity-difficulty*
*Completed: 2026-01-23*
