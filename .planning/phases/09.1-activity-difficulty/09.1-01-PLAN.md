---
phase: 09.1-activity-difficulty
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/difficulty.ts
  - src/config/balance.ts
  - src/entities/types.ts
  - src/entities/Activity.ts
autonomous: true

must_haves:
  truths:
    - "Activity has baseDifficulty property (1-5 stars)"
    - "Activity has skillRequirements array with skill IDs and weights"
    - "Activity.getEffectiveDifficulty(character) returns personalized difficulty"
    - "Activity.getDifficultyBreakdown(character) returns skill contributions"
    - "Difficulty reduction uses square root diminishing returns"
  artifacts:
    - path: "src/types/difficulty.ts"
      provides: "SkillRequirement, DifficultyBreakdown, DifficultyConfig interfaces"
      exports: ["SkillRequirement", "DifficultyBreakdown", "DifficultyConfig"]
    - path: "src/config/balance.ts"
      provides: "Difficulty configuration section"
      contains: "DifficultyConfig"
    - path: "src/entities/Activity.ts"
      provides: "Difficulty calculation methods"
      exports: ["getEffectiveDifficulty", "getDifficultyBreakdown"]
  key_links:
    - from: "src/entities/Activity.ts"
      to: "src/types/difficulty.ts"
      via: "import SkillRequirement, DifficultyBreakdown"
      pattern: "import.*SkillRequirement"
    - from: "src/entities/Activity.ts"
      to: "Character.getSkill"
      via: "skill lookup for reduction calculation"
      pattern: "character\\.getSkill"
---

<objective>
Establish the difficulty calculation foundation: types for skill requirements and difficulty breakdown, config for diminishing returns curves, and Activity entity methods for computing personalized difficulty.

Purpose: Enable activities to have base difficulty modified by skill levels and mastery, with full breakdown data for UI display.
Output: Working difficulty calculation that can be tested programmatically before UI integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09.1-activity-difficulty/09.1-CONTEXT.md
@.planning/phases/09.1-activity-difficulty/09.1-RESEARCH.md

# Existing patterns
@src/entities/Activity.ts
@src/entities/Character.ts
@src/entities/Skill.ts
@src/entities/types.ts
@src/config/balance.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Difficulty Types and Config</name>
  <files>
    src/types/difficulty.ts (new)
    src/config/balance.ts
    src/entities/types.ts
  </files>
  <action>
Create `src/types/difficulty.ts` with:
- `SkillRequirement` interface: `{ skillId: string; weight: number; maxReduction: number }`
- `DifficultyBreakdown` interface for tooltip display: `{ base: number; effective: number; skillReduction: number; masteryReduction: number; skillDetails: Array<{ skillId: string; skillName: string; level: number; reduction: number }> }`
- `DifficultyConfig` interface for balance tuning

In `src/config/balance.ts`:
- Add `DifficultyConfig` interface with: `maxSkillReduction: number` (default 1.5), `maxMasteryReduction: number` (default 1.0), `skillDiminishingReturns: 'sqrt' | 'linear'` (default 'sqrt')
- Add `DEFAULT_DIFFICULTY_CONFIG` with sensible defaults
- Add `difficulty: DifficultyConfig` to `BalanceConfig` interface
- Add `difficultyConfig` getter to `BalanceConfigStore`

In `src/entities/types.ts`:
- Add `skillRequirements?: SkillRequirement[]` and `baseDifficulty?: number` to `ActivityData` interface (optional for backward compat)
- Import `SkillRequirement` from `../types/difficulty`

Do NOT create src/types directory if it doesn't exist - put difficulty.ts there only if the directory exists, otherwise create it.
  </action>
  <verify>
TypeScript compiles without errors: `npm run build` or `npx tsc --noEmit`
  </verify>
  <done>
SkillRequirement and DifficultyBreakdown types exist and are importable. ActivityData accepts optional baseDifficulty and skillRequirements. DifficultyConfig is in balance.ts with defaults.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Difficulty Calculation on Activity</name>
  <files>src/entities/Activity.ts</files>
  <action>
Add difficulty calculation methods to Activity class:

1. Add optional readonly properties from constructor data:
   - `readonly baseDifficulty: number` (default 3 if not provided)
   - `readonly skillRequirements: SkillRequirement[]` (default [] if not provided)

2. Implement `calculateSkillReduction(character: Character): number`:
   - Iterate over skillRequirements
   - For each requirement, get skill level from character via `character.skills?.get(req.skillId)?.level || 0`
   - Apply square root diminishing returns: `sqrt(level / 5) * req.maxReduction * req.weight`
   - Sum weighted reductions, normalize by total weight
   - Cap at config.maxSkillReduction (from root.balanceConfig if available)

3. Implement `calculateMasteryReduction(): number`:
   - Use existing masteryLevel (1-10)
   - Apply square root: `sqrt((masteryLevel - 1) / 9) * maxMasteryReduction`
   - Cap at config.maxMasteryReduction

4. Implement `getEffectiveDifficulty(character: Character): number`:
   - Calculate: `baseDifficulty - skillReduction - masteryReduction`
   - Clamp to [1, 5] range
   - Return clamped value

5. Implement `getDifficultyBreakdown(character: Character): DifficultyBreakdown`:
   - Build breakdown object with base, effective, reductions, and per-skill details
   - Include skill names by looking up skill.name from character.skills

Import Character type (use type-only import to avoid circular deps), SkillRequirement and DifficultyBreakdown from types.
  </action>
  <verify>
TypeScript compiles: `npm run build` or `npx tsc --noEmit`
  </verify>
  <done>
Activity has getEffectiveDifficulty(character) returning 1-5 and getDifficultyBreakdown(character) returning full breakdown. Methods handle missing skills gracefully (return baseDifficulty if no character/skills).
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Activity class has new methods: getEffectiveDifficulty, getDifficultyBreakdown
3. DifficultyConfig exists in BalanceConfigStore with accessible getter
4. ActivityData type accepts optional baseDifficulty and skillRequirements
</verification>

<success_criteria>
- Activity entity can calculate personalized difficulty given a Character
- Difficulty breakdown provides per-skill contribution data
- Square root diminishing returns prevents min/maxing
- All types are properly exported and importable
- Backward compatible: activities without baseDifficulty default to 3 stars
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-activity-difficulty/09.1-01-SUMMARY.md`
</output>
