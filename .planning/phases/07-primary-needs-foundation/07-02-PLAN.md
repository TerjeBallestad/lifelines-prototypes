---
phase: 07-primary-needs-foundation
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/stores/RootStore.ts
  - src/entities/Character.ts
  - src/components/NeedBar.tsx
  - src/components/NeedsPanel.tsx
  - src/components/SimulationControls.tsx
  - src/components/CharacterPanel.tsx
autonomous: true

must_haves:
  truths:
    - "Global toggle switches between v1.0 resources and v1.1 needs system"
    - "When toggle enabled, needs decay instead of resources"
    - "NeedsPanel displays 7 needs in two groups (Physiological, Social)"
    - "Need bars show color-coded urgency (green > yellow > orange > red)"
    - "Critical needs (below 20%) display red bars"
  artifacts:
    - path: "src/stores/RootStore.ts"
      provides: "needsSystemEnabled toggle, toggleNeedsSystem() action"
      contains: "needsSystemEnabled"
    - path: "src/components/NeedBar.tsx"
      provides: "Individual need bar with color gradient"
      exports: ["NeedBar"]
    - path: "src/components/NeedsPanel.tsx"
      provides: "Grouped needs display (Physiological + Social)"
      exports: ["NeedsPanel"]
    - path: "src/components/SimulationControls.tsx"
      provides: "Toggle UI for v1.0/v1.1 system switch"
      contains: "needsSystemEnabled"
  key_links:
    - from: "src/stores/RootStore.ts"
      to: "src/entities/Character.ts"
      via: "toggleNeedsSystem calls initializeNeeds"
      pattern: "char\\.initializeNeeds"
    - from: "src/entities/Character.ts"
      to: "src/stores/RootStore.ts"
      via: "applyTickUpdate checks needsSystemEnabled"
      pattern: "needsSystemEnabled"
    - from: "src/components/NeedsPanel.tsx"
      to: "src/entities/types.ts"
      via: "imports Needs type"
      pattern: "import.*Needs"
---

<objective>
Wire up the needs system toggle and create the visual UI for displaying needs with color-coded urgency.

Purpose: This plan enables switching between v1.0 (flat resource drain) and v1.1 (needs-based simulation), and provides visual feedback for the 7 primary needs with urgency indicators. The toggle allows validating v1.1 while preserving working v1.0 mechanics.

Output: Global toggle in RootStore, Character.applyTickUpdate respects toggle, NeedBar and NeedsPanel components, toggle UI in SimulationControls.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-primary-needs-foundation/07-CONTEXT.md
@.planning/phases/07-primary-needs-foundation/07-RESEARCH.md
@.planning/phases/07-primary-needs-foundation/07-01-SUMMARY.md
@src/stores/RootStore.ts
@src/entities/Character.ts
@src/components/ResourcePanel.tsx
@src/components/ResourceGauge.tsx
@src/components/SimulationControls.tsx
@src/components/CharacterPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Toggle to RootStore and Wire Character</name>
  <files>src/stores/RootStore.ts, src/entities/Character.ts</files>
  <action>
1. In `src/stores/RootStore.ts`:
   - Add observable property `needsSystemEnabled = false`
   - Add action `toggleNeedsSystem(): void` that:
     - Flips `this.needsSystemEnabled`
     - If now enabled, iterates `this.characterStore.allCharacters` and calls `char.initializeNeeds()` on each
   - Ensure makeAutoObservable is applied (it should be via class pattern, but verify)

2. In `src/entities/Character.ts`:
   - Modify `applyTickUpdate(speedMultiplier: number): void` to check toggle:
     ```typescript
     applyTickUpdate(speedMultiplier: number): void {
       const needsEnabled = this.root?.needsSystemEnabled ?? false;

       if (needsEnabled && this.needs) {
         this.applyNeedsDecay(speedMultiplier);
       } else {
         // Existing v1.0 resource drain/recovery code
         // (keep all existing for/of loops unchanged)
       }
     }
     ```
   - The existing drain/recovery loops move into the else branch

This ensures both systems work but only one runs at a time.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Grep confirms toggle: `grep -n "needsSystemEnabled" src/stores/RootStore.ts` returns matches
Grep confirms Character check: `grep -n "needsSystemEnabled" src/entities/Character.ts` returns matches
  </verify>
  <done>
RootStore has needsSystemEnabled toggle with toggleNeedsSystem() action. Character.applyTickUpdate branches based on toggle - needs decay when enabled, v1.0 resources drain when disabled.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create NeedBar and NeedsPanel Components</name>
  <files>src/components/NeedBar.tsx, src/components/NeedsPanel.tsx</files>
  <action>
1. Create `src/components/NeedBar.tsx`:
   - Props: `value: number`, `label: string`, `decayRate: number`, `criticalThreshold: number`
   - Compute color based on value thresholds:
     - >= 70: green (success)
     - >= 40: yellow (warning)
     - >= 20: orange (via Tailwind bg-orange-500)
     - < 20: red (error) - this is critical state
   - Use DaisyUI progress bar component
   - Show percentage value and label
   - Add title attribute showing decay rate on hover: `title={Decay: ${decayRate.toFixed(2)}/tick}`
   - If value < criticalThreshold, add visual indicator (pulsing glow, bold text, or icon)

2. Create `src/components/NeedsPanel.tsx`:
   - Props: `needs: Needs`, `needsConfig: NeedsConfig` (for decay rates and threshold)
   - Define two arrays for grouping:
     - Physiological: ['hunger', 'energy', 'hygiene', 'bladder']
     - Social: ['social', 'fun', 'security']
   - Render two sections with headers
   - Map each need to NeedBar with appropriate props
   - Use grid layout (2 columns) similar to ResourcePanel pattern
   - Add nice labels: Hunger, Energy, Hygiene, Bladder, Social, Fun, Security

Follow existing component patterns:
- Use `observer` from mobx-react-lite
- Use TypeScript interfaces for props
- Use Tailwind for styling
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Files exist: `ls src/components/NeedBar.tsx src/components/NeedsPanel.tsx`
  </verify>
  <done>
NeedBar component displays single need with color-coded progress bar (green/yellow/orange/red). NeedsPanel groups needs into Physiological and Social sections with header labels. Critical needs (< 20%) have visual warning indicator.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Toggle UI and Integrate NeedsPanel</name>
  <files>src/components/SimulationControls.tsx, src/components/CharacterPanel.tsx</files>
  <action>
1. In `src/components/SimulationControls.tsx`:
   - Import `useRootStore` if not already
   - Add toggle UI after existing speed controls:
     ```tsx
     <div className="form-control">
       <label className="label cursor-pointer gap-2">
         <span className="label-text">v1.1 Needs</span>
         <input
           type="checkbox"
           className="toggle toggle-primary"
           checked={root.needsSystemEnabled}
           onChange={() => root.toggleNeedsSystem()}
         />
       </label>
     </div>
     ```
   - Position appropriately in the controls layout

2. In `src/components/CharacterPanel.tsx`:
   - Import NeedsPanel component
   - Import useRootStore to access needsSystemEnabled
   - Conditionally render either ResourcePanel or NeedsPanel based on toggle:
     ```tsx
     {root.needsSystemEnabled && character.needs ? (
       <NeedsPanel
         needs={character.needs}
         needsConfig={root.balanceConfig.config.needs}
       />
     ) : (
       <ResourcePanel resources={character.resources} />
     )}
     ```
   - Ensure the switch happens smoothly without layout jump

This completes the visual integration - users can toggle between v1.0 and v1.1 display.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
App starts: `npm run dev` (verify manually or check for build errors)
Grep confirms toggle UI: `grep -n "needsSystemEnabled" src/components/SimulationControls.tsx`
Grep confirms conditional render: `grep -n "NeedsPanel" src/components/CharacterPanel.tsx`
  </verify>
  <done>
SimulationControls has toggle switch labeled "v1.1 Needs". CharacterPanel conditionally shows NeedsPanel when toggle enabled, ResourcePanel when disabled. Toggle is visible in main UI.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run dev` starts without errors
3. Toggle exists in SimulationControls UI
4. Clicking toggle switches between ResourcePanel and NeedsPanel display
5. NeedsPanel shows 7 needs in two groups
6. Needs bars change color based on value (visually verify green/yellow/orange/red)
</verification>

<success_criteria>
- Toggle switch visible in SimulationControls, labeled "v1.1 Needs"
- Toggle off: ResourcePanel displays (v1.0 behavior unchanged)
- Toggle on: NeedsPanel displays with 7 needs in Physiological/Social groups
- Needs decay over time when simulation runs with toggle on
- Color coding works: high values green, low values red
- Critical needs (< 20%) have visual warning indicator
</success_criteria>

<output>
After completion, create `.planning/phases/07-primary-needs-foundation/07-02-SUMMARY.md`
</output>
